<!DOCTYPE html>
<html>
  <head>
    <title>KeyChain test page</title>
    <link rel="stylesheet" href="assets/spectre.min.css">
    <style>
      button {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="columns">
        <div class="column col-2 ">
        </div>
        <div class="column col-2">
          <img src="assets/logo.png">
        </div>
        <div class="column col mx-2 my-2">
          <h1>KeyChain demo</h1>
          <h6>Test the WebSocket commands of Key–°hain v.0.9 - a highly secure key management app for generating keys and signing transactions.</h6>
          <h6>Documentation: <a href="https://github.com/arrayio/array-io-keychain/wiki/KeyChain-Protocol">KeyChain Protocol</a></h6>
        </div>
      </div>
      <div class="columns m-1">
        <div class="column col-2 ">
          <button class="btn btn-primary" id="btn_LIST">List</button>
        </div>
      </div>
      <div class="columns m-1">
        <div class="column col-2">
          <button class="btn btn-primary" id="btn_LOCK">Lock</button>
        </div>  
      </div>
      <div class="columns m-1">
        <div class="column col-2">
          <button class="btn btn-primary" id="btn_UNLOCK">Unlock</button>
        </div>
        <div class="column col-8">
          <input type="text" class="form-input" placeholder="test1@be5f6e75878b84ba" id="input_UNLOCK">
        </div>
      </div>
      <div class="columns m-1">
        <div class="column col-2">
          <button class="btn btn-primary input-group-btn" id="btn_SET_UNLOCK_TIME">Set unlock time</button>
        </div>  
        <div class="column col-8">  
          <input type="text" class="form-input" placeholder="300" id="input_SET_UNLOCK_TIME">
        </div>
      </div>
      <div class="columns m-1">
        <div class="column col-2">
          <button class="btn btn-primary input-group-btn" id="btn_PUBLIC_KEY">Public key</button>
        </div>
        <div class="column col-8">
          <input type="text" class="form-input" placeholder="test1@be5f6e75878b84ba" id="input_PUBLIC_KEY">
        </div>
      </div>
      <div class="columns m-1">
        <div class="column col-2">
          <button class="btn btn-primary input-group-btn" id="btn_SIGN_HEX">Sign hex</button>
        </div>  
        <div class="column col-8">  
          <input type="text" class="form-input" placeholder="test1@be5f6e75878b84ba" id="input_SIGN_HEX">
        </div>
      </div>
      <div class="columns m-1">
        <div class="column col-2">
          <button class="btn btn-primary input-group-btn" id="btn_SIGN_HASH">Sign hash</button>
        </div>
        <div class="column col-8">
          <input type="text" class="form-input" placeholder="test1@be5f6e75878b84ba" id="input_SIGN_HASH">
        </div>
      </div>
      <div class="columns m-1">
        <div class="column col-2">
          <button class="btn btn-primary input-group-btn" id="btn_CREATE">Create</button>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="columns">
        <div class="column col-6">
          <label class="form-label" for="request">Request</label>
          <textarea class="form-input" id="request" placeholder="{}" rows="9"></textarea>
        </div>
        <div class="column col-6">
          <label class="form-label" for="response">Response</label>
          <textarea class="form-input" id="response" placeholder="{}" rows="9"></textarea>
        </div>
      </div>
    </div>
    
    <script>
      const ws = new WebSocket('ws://localhost:16384/');

      ws.onopen = function() {
        document.body.style.backgroundColor = '#cfc';
      };
      ws.onclose = function() {
        document.body.style.backgroundColor = null;
      };
      ws.onmessage = function(event) {
        document.getElementById('response').textContent = JSON.stringify(JSON.parse(event.data), undefined, 2);
      };
      
      const commands = {
        UNLOCK: {
          command: "unlock",
          params: {
            keyname: null
          }
        },
        SET_UNLOCK_TIME: {
          command: "set_unlock_time",
          params: {
            seconds: null
          }
        },
        PUBLIC_KEY: {          
          command: "public_key",
          params: {
            keyname: null
          }
        },
        SIGN_HEX: {
          command: "sign_hex",
          params: {
            chainid: "03",
            transaction: "eb0885098bca5a00825208948ec6977b1255854169e5f9f8f163f371bcf1ffd287038d7ea4c6800080038080",
            blockchain_type: "ethereum",
            keyname: null
          }
        },
        SIGN_HASH: {
          command: "sign_hash",
          params: {
            sign_type: "VRS_canonical",
            hash: "fe5e4a8974715e20f47c8bb609547c9e66b0b9e31d521199b3d8d6af6da74cb1",
            keyname: null
          }
        },
        CREATE: {
          command: "create",
          params: {
            keyname: "test1",
            encrypted: true,
            curve: "secp256k1",
            cipher: "aes256"
          }
        },
        LIST: {
          command: "list"
        },
        LOCK: {
          command: "lock"
        }
      }

      window.onload = function () {
        attachListener('UNLOCK', 'keyname');
        attachListener('SET_UNLOCK_TIME', 'seconds');
        attachListener('PUBLIC_KEY', 'keyname');
        attachListener('SIGN_HEX', 'keyname');
        attachListener('SIGN_HASH', 'keyname');
        attachListener('CREATE');
        attachListener('LIST');
        attachListener('LOCK');
      }
       
      function attachListener(commandName, paramName) {
        document.getElementById(`btn_${commandName}`).addEventListener('click', function() {
          if (paramName) {
            const inputValue = document.getElementById(`input_${commandName}`).value;
            commands[commandName].params[paramName] = inputValue;
          }
          const data = JSON.stringify(commands[commandName], undefined, 2);
          document.getElementById('request').value = data;
          ws.send(data);
        });
      }
    </script>
    
  </body>
</html>
