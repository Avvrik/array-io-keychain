<!DOCTYPE html>
<html lang="en">
  <head>
    <title>ETH Signer</title>
    <link rel="stylesheet" href="../assets/spectre.min.css">
  </head>
  <body>
    <div class="container">
      <div class="columns" id="error" style="display: none">
        <div class="column my-2">
          <div class="toast toast-error">
            WebSocket connection failed. Check if KeyChain is installed
          </div>
        </div>
      </div>
      <div class="columns">
        <div class="column col-2">
          <img src="../assets/logo.png" alt="KeyChain logo">
        </div>
        <div class="column col mx-2 my-2">
          <h1>ETH Signer</h1>
          <h6>Sign and publish Ethereum transactions with KeyChain <span id="version"></span> - a highly secure key management app.</h6>
          <h6>Documentation: <a href="https://github.com/arrayio/array-io-keychain/wiki/How-to-sign-Ethereum-transaction-via-KeyChain">How to sign Ethereum transaction via KeyChain</a></h6>
        </div>
      </div>
      <div class="container">
        <div class="form-group">
          <label class="form-label" for="input-endpoint">Endpoint</label>
          <input class="form-input" type="text" id="input-endpoint" value="https://ropsten.infura.io/v3/046804e3dd3240b09834531326f310cf" />
        </div>
        <div class="form-group">
          <label class="form-label" for="input-keyname">Keyname</label>
          <input class="form-input" type="text" id="input-keyname" placeholder="test1@6de493f01bf590c0" />
        </div>
        <div class="form-group">
          <label class="form-label" for="input-to-address">To address</label>
          <input
            class="form-input"
            type="text"
            id="input-to-address"
            value="0xE8899BA12578d60e4D0683a596EDaCbC85eC18CC"
          />
        </div>
      </div>
      <div class="columns my-2 mx-1">
        <div class="column col-4 ">
          <button class="btn btn-primary" id="btn_SIGN">Sign</button>
          <button class="btn btn-primary" id="btn_PUBLISH">Publish</button>
        </div>
      </div>
    </div>  
    <div class="container">
      <div class="columns">
        <div class="column col">
          <label class="form-label" for="log">Log</label>
          <textarea class="form-input" id="log" rows="15"></textarea>
        </div>
      </div>
      <div class="columns my-2">
        <div class="column col-6">
          Raw Hex: <span id="rawHex" style="font-style: italic">Please, sign your transaction</span>
        </div>
        <div class="column col-6" id="etherscanLink"></div>
      </div>
      <div class="container">
        <progress class="progress" style="display: none" max="100" id="progress"></progress>
      </div>
    </div>
    <script src="../keychain.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js" integrity="sha256-nWBTbvxhJgjslRyuAKJHK+XcZPlCnmIAAMixz6EefVk=" crossorigin="anonymous"></script>
    <script src="https://cdn.rawgit.com/ethereumjs/browser-builds/2fb69a714afe092b06645286f14b94f41e5c062c/dist/ethereumjs-tx.js"></script>

    <script>
      let rawHexGlobal;

      window.onload = function () {
        let web3;
        const valueTx = 100;

        const keychain = new WS('ws://localhost:16384/');

        keychain.ws.onopen = function() {
          document.body.style.backgroundColor = '#cfc';
          keychain.method({command: 'version'})
                  .then(data => {
                    document.getElementById('version').innerText = data.result;
                  })
        };
        keychain.ws.onclose = function() {
          document.body.style.backgroundColor = null;
          document.getElementById('error').style.display = 'block';
        };

        document.getElementById('btn_SIGN').addEventListener('click', function() {
          const endpoint = document.getElementById('input-endpoint').value;
          web3 = new Web3(new Web3.providers.HttpProvider(endpoint));
          const keyname = document.getElementById('input-keyname').value;
          const toAddress = document.getElementById('input-to-address').value;
          let fromAddress;

          log(`Getting public key by keyname from KeyChain: ${keyname}`);
          keychain.method({ command: 'public_key', params: { keyname } }).then(data => {
            log(`Result: ${JSON.stringify(data)}`);
            if (data.error) {
              throw data.error;
            }
            const publicKey = `0x${data.result}`;
            return EthJS.Util.publicToAddress(publicKey).toString('hex');
          }).then( data => {
            fromAddress = data;
            log(`"From" address calculated from public key: ${fromAddress}`);
            log('Building transaction with empty signature');
            return buildTx(fromAddress, toAddress, valueTx);
          }).then (tx => {
            log(`Result: ${JSON.stringify(tx)}`);
            log(`Signing it with KeyChain`);
            // const privateKey = 'b3d3427eea7867c243baaf2f4c67a9551eea2ea96556acfb0051dffa18d182d4';
            // return web3.eth.accounts.signTransaction(tx, privateKey);
            return keychain.signTransaction(tx, keyname);
          }).then( result => {
            log(`Result: ${JSON.stringify(result)}`);
            const rawHex = result.rawTransaction;
            log(`Transaction built, rawHex: ${rawHex}`);
            log(`Please, publish your transaction`);
            document.getElementById('rawHex').innerText = rawHex;
            rawHexGlobal = rawHex;
          }).catch(log)
        });

        document.getElementById('btn_PUBLISH').addEventListener('click', async function() {
          if (!rawHexGlobal) {
            log('Please sign your transaction');
            return;
          }
          log(`Sending signed transaction: ${rawHexGlobal}`);
          try {
            document.getElementById('progress').style.display = 'inline-block';
            const result = await web3.eth.sendSignedTransaction(`${rawHexGlobal}`);
            document.getElementById('progress').style.display = 'none';
            log(`Transfer result: \n${JSON.stringify(result, undefined, 2)}`);
            document.getElementById('etherscanLink').innerHTML = `<a href='https://ropsten.etherscan.io/tx/${result.transactionHash}'>Etherscan Link</a>`;
          } catch (e) {
            console.log(e);
            log(e);
            document.getElementById('progress').style.display = 'none';
          }
        });

        const buildTx = async (from, to, value) => {
          const nonce = await web3.eth.getTransactionCount(from);
          const chainId = 3;
          const data = '';
          const gasPrice = await web3.eth.getGasPrice().then(Number);
          const gas = 21000;

          return { nonce, chainId, to, value, data, gasPrice, gas }
        };
      };

      function log(message) {
        const loggerElement = document.getElementById('log');
        if (loggerElement.value) {
          loggerElement.value += '\n';
        }
        loggerElement.value += message;
      }
    </script>
    
  </body>
</html>
