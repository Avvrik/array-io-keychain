<?xml version="1.0" encoding="utf-8"?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
	xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
	
	<!-- Set product information -->
	<!-- Product ID must be autogenerated (*) else major upgrades will not work -->
    <Product Id="*" UpgradeCode="{F5AB3271-27C0-4C4B-9B90-6250790AFF76}" 	 
			Name="KeyChain" Language="1033" Version="$(var.productversion)" 
			Manufacturer="Array.IO">
	
	<!-- Set package and media information -->
	<!-- Package ID are valid for a single package version only -->
    <Package Id="*" Description="pak" InstallerVersion="400" Compressed="yes" Platform = "x64" InstallScope="perMachine"/>
    <Media Id="1" Cabinet="setup.cab" EmbedCab="yes" />
	<Property Id="MSIUSEREALADMINDETECTION" Value="1" />
	
	<!-- Upgrade package and media information -->
	<MajorUpgrade
	Schedule="afterInstallInitialize"
	DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit."/>
	
	<!-- Upgrade ID must be autogenerated (*) else major upgrades will not work -->
	<Upgrade Id="{591429D8-0A55-4B25-9CAF-8687BE86A38B}">
	<UpgradeVersion Minimum="$(var.productversion)" IncludeMinimum="yes"
		Maximum="9.9.9" IncludeMaximum="yes"
		OnlyDetect="no" Property="CURRENTVERSIONDETECTED" />
    </Upgrade>
	
	<!-- Check if .NET Framework 3.5 is installed -->
	<PropertyRef Id="NETFRAMEWORK35" />
	
	<!-- Override root install directory path -->
	<SetDirectory Id="RootInstallDrive" Value="C:\Program Files" />
	
	<!-- 
	RemoveFolder requires that we "remember" the path for uninstall. 
	Read the path value and set the APPLICATIONFOLDER property with the value
	-->
	<Property Id="INSTALLLOCATION">
	  <RegistrySearch Key="SOFTWARE\KeyChain\KeyChain" Root="HKLM" Type="raw" Id="APPLICATIONFOLDER_REGSEARCH" Name="Path" />
	</Property>
	
	<!-- Fragment of sources to install -->
	<!-- Every build - new GUID values -->
    <Directory Id="TARGETDIR" Name="SourceDir">
		<Directory Id="RootInstallDrive">
			<Directory Id="INSTALLLOCATION" Name="KeyChain">
				<Component Id="Component1" DiskId="1" Guid="{06D319F8-E7BF-4FB6-94D0-C33935ACA1E0}">
					<File Id="File0" Name="websocketwrapper.exe" Source="websocketwrapper.exe" />
				</Component>
				<Component Id="Component2" DiskId="1" Guid="{AB9BD4D7-7BAC-40A5-BBFC-A0F03D8594D9}">
					<File Id="File1" Name="servicewrapper.exe" Source="servicewrapper.exe" />
				</Component>
				<Component Id="Component3" DiskId="1" Guid="{8E378A95-ACDA-46C2-B999-23AB11B40992}">
					<File Id="File2" Name="servicewrapper.xml" Source="servicewrapper.xml" />
				</Component>
				<Component Id="Component4" DiskId="1" Guid="{BA86DD6E-4130-4F6B-AE3C-250CB256A9B4}">
					<File Id="File3" Name="wsservicerunner.bat" Source="wsservicerunner.bat" />
				</Component>
				<Component Id="Component5" DiskId="1" Guid="{FEE4C5E2-B065-4A39-8DA4-B702E05DDD79}">
					<File Id="File4" Name="delete_wsservice.bat" Source="delete_wsservice.bat" />
				</Component>
				<Component Id="Component6" DiskId="1" Guid="{BBF8E2D0-2031-4FDD-A59E-9AE051CBAF9C}">
					<File Id="File5" Name="wsservice_manager.bat" Source="wsservice_manager.bat" />
				</Component>
				<Component Id="Component7" DiskId="1" Guid="{2ABDFB6C-DE7B-478E-9EEA-170263F92F39}">
					<File Id="File6" Name="keychain.exe" Source="keychain.exe" />
				</Component>
				<Component Id="Component8" DiskId="1" Guid="{6A226C25-1DD5-4D56-B7E4-F8E78AE7CE9A}">
					<File Id="File7" Name="keychain_win_gui.exe" Source="keychain_win_gui.exe" />
				</Component>
				<Directory Id="DemoComponents" Name="demo">
					<Component Id="Component10" DiskId="1" Guid="{28EC35AD-2FAE-46E3-BCA6-A3E3934F5FBB}">
					<File Id="File9" Name="index.html" Source="demo\index.html" />
					</Component>
					<Component Id="Component11" DiskId="1" Guid="{8889397E-A1B5-494B-A578-25E84CF7F99A}">
					<File Id="File10" Name="logo.png" Source="demo\logo.png" />
					<CreateFolder/>
					</Component>
					<Component Id="Component12" DiskId="1" Guid="{A1658803-81BD-4E3C-8C19-35A219244235}">
						<File Id="File11" Name="spectre.min.css" Source="demo\spectre.min.css" />
					<CreateFolder/>
					</Component>
					<Component Id="Component49" DiskId="1" Guid="{91E8A8CE-2C0C-4614-91A4-B18CEB2EEC65}">
						<File Id="File48" Name="keychain.js" Source="demo\keychain.js" />
					<CreateFolder/>
					</Component>
				</Directory>
				<Component Id="Component13" DiskId="1" Guid="{2A2BFA73-4409-4309-AC98-5BD69AF775E8}">
					<File Id="File12" Name="libcrypto-1_1-x64.dll" Source="libcrypto-1_1-x64.dll" />
				</Component>
				<Component Id="Component14" DiskId="1" Guid="{05B828FC-1244-4372-A03C-E219946B690C}">
					<File Id="File13" Name="check_service.bat" Source="check_service.bat" />
				</Component>
				<Component Id="Component15" DiskId="1" Guid="{33193531-76EF-4346-B74C-7A4B2D6E3D31}">
					<File Id="File14" Name="Qt5Core.dll" Source="Qt5Core.dll" />
				</Component>
				<Component Id="Component16" DiskId="1" Guid="{581E80CE-8F90-4442-99DB-D6A1F044786E}">
					<File Id="File15" Name="Qt5Widgets.dll" Source="Qt5Widgets.dll" />
				</Component>
				<Component Id="Component17" DiskId="1" Guid="{EFB4A958-39B5-47CD-8CEB-4DF2AB686B6E}">
					<File Id="File16" Name="Qt5Gui.dll" Source="Qt5Gui.dll" />
				</Component>
				<Directory Id="QtPlatformComponents" Name="platforms">
					<Component Id="Component18" DiskId="1" Guid="{8667C194-D228-4FFF-B201-34873290D983}">
					<File Id="File17" Name="qdirect2d.dll" Source="platforms\qdirect2d.dll" />
					</Component>
					<Component Id="Component19" DiskId="1" Guid="{3FDF5E8D-1D63-4492-80EF-1C0F7FC4CA20}">
					<File Id="File18" Name="qdirect2dd.dll" Source="platforms\qdirect2dd.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component20" DiskId="1" Guid="{D9005038-80DB-42B9-97BE-EB1280EB5F1D}">
					<File Id="File19" Name="qminimal.dll" Source="platforms\qminimal.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component21" DiskId="1" Guid="{A95891C7-46B4-496E-ACDB-8D82AD406577}">
					<File Id="File20" Name="qminimald.dll" Source="platforms\qminimald.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component22" DiskId="1" Guid="{EFD68E95-213E-471F-80F5-B43EB6157B5B}">
					<File Id="File21" Name="qoffscreen.dll" Source="platforms\qoffscreen.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component23" DiskId="1" Guid="{802B2052-F7CF-4434-8B15-795DD4810CCD}">
					<File Id="File22" Name="qoffscreend.dll" Source="platforms\qoffscreend.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component24" DiskId="1" Guid="{E14CF8F9-49B2-4BF0-A2A9-28C7D323EC36}">
					<File Id="File23" Name="qwindows.dll" Source="platforms\qwindows.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component25" DiskId="1" Guid="{C0C70658-9B9C-4065-9B7C-AE437F99E4FD}">
					<File Id="File24" Name="qwindowsd.dll" Source="platforms\qwindowsd.dll" />
					<CreateFolder/>
					</Component>
				</Directory>
				<Directory Id="QtStylesComponents" Name="styles">
					<Component Id="Component26" DiskId="1" Guid="{8BFF929E-91B9-45E1-BB65-59A0835FBF4E}">
					<File Id="File25" Name="qwindowsvistastyle.dll" Source="styles\qwindowsvistastyle.dll" />
					</Component>
					<Component Id="Component27" DiskId="1" Guid="{10A2E5A5-F46C-4E39-924D-9894FDA77432}">
					<File Id="File26" Name="qwindowsvistastyled.dll" Source="styles\qwindowsvistastyled.dll" />
					<CreateFolder/>
					</Component>
				</Directory>
				<Directory Id="QtImageFormatsComponents" Name="imageformats">
					<Component Id="Component28" DiskId="1" Guid="{0CB8F21A-4A44-4E1B-8556-D57DBBA816EB}">
					<File Id="File27" Name="qgif.dll" Source="imageformats\qgif.dll" />
					</Component>
					<Component Id="Component29" DiskId="1" Guid="{074704CB-8B8B-4964-999A-36B8B0FAD547}">
					<File Id="File28" Name="qgifd.dll" Source="imageformats\qgifd.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component30" DiskId="1" Guid="{49B4839E-4F01-4629-8066-746E9AE0D07B}">
					<File Id="File29" Name="qicns.dll" Source="imageformats\qicns.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component31" DiskId="1" Guid="{96979C78-4C2D-4737-A1EC-9980DE2ADA75}">
					<File Id="File30" Name="qicnsd.dll" Source="imageformats\qicnsd.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component32" DiskId="1" Guid="{357547B3-91D3-4A78-855E-546E8C10DE35}">
					<File Id="File31" Name="qico.dll" Source="imageformats\qico.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component33" DiskId="1" Guid="{6ADCFE16-27DD-4C97-A39D-D1CF4343A43F}">
					<File Id="File32" Name="qicod.dll" Source="imageformats\qicod.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component34" DiskId="1" Guid="{8734A26D-7275-433E-8099-54B39A2B082D}">
					<File Id="File33" Name="qjpeg.dll" Source="imageformats\qjpeg.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component35" DiskId="1" Guid="{5E55E09B-5DA1-40C8-9082-6605DFC54A49}">
					<File Id="File34" Name="qjpegd.dll" Source="imageformats\qjpegd.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component36" DiskId="1" Guid="{38DF96CA-60DE-42C5-AF5A-311DE9B32919}">
					<File Id="File35" Name="qsvg.dll" Source="imageformats\qsvg.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component37" DiskId="1" Guid="{C09A83B5-8F77-4FF2-AF2E-7CEB806D98B5}">
					<File Id="File36" Name="qsvgd.dll" Source="imageformats\qsvgd.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component38" DiskId="1" Guid="{7C5FC71C-7D09-4AC8-8990-3A262CB17BEF}">
					<File Id="File37" Name="qtga.dll" Source="imageformats\qtga.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component39" DiskId="1" Guid="{F050091B-EFAC-46E3-A022-5DDCB2474269}">
					<File Id="File38" Name="qtgad.dll" Source="imageformats\qtgad.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component40" DiskId="1" Guid="{A2C670C1-5D20-49A2-91C3-74F01B9939A9}">
					<File Id="File39" Name="qtiff.dll" Source="imageformats\qtiff.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component41" DiskId="1" Guid="{0911413C-F8E9-4A3C-93AF-BE851C162BA1}">
					<File Id="File40" Name="qtiffd.dll" Source="imageformats\qtiffd.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component42" DiskId="1" Guid="{54FCE3BB-824A-4C7A-AAA9-4CDEDF794DE8}">
					<File Id="File41" Name="qwbmp.dll" Source="imageformats\qwbmp.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component43" DiskId="1" Guid="{04309F00-D609-45CB-994F-2F24BB25BB30}">
					<File Id="File42" Name="qwbmpd.dll" Source="imageformats\qwbmpd.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component44" DiskId="1" Guid="{70433299-48F0-491B-ABA2-6567879EC623}">
					<File Id="File43" Name="qwebp.dll" Source="imageformats\qwebp.dll" />
					<CreateFolder/>
					</Component>
					<Component Id="Component45" DiskId="1" Guid="{744C2B1F-5785-4C56-9948-CF471607778B}">
					<File Id="File44" Name="qwebpd.dll" Source="imageformats\qwebpd.dll" />
					<CreateFolder/>
					</Component>
				</Directory>
				<Component Id="Component46" DiskId="1" Guid="{8E6EBEC9-E97C-4223-9ED6-3D69EF07254F}">
				<File Id="File45" Name="Qt5Qml.dll" Source="Qt5Qml.dll" />
				</Component>
				<Component Id="Component47" DiskId="1" Guid="{0B935291-E2BA-4102-8C08-10512EDCEE04}">
				<File Id="File46" Name="Qt5Svg.dll" Source="Qt5Svg.dll" />
				</Component>
				<Component Id="Component48" DiskId="1" Guid="{250E3A2F-A33A-402C-AC3A-1169F8ECDA97}">
				<File Id="File47" Name="Qt5Xml.dll" Source="Qt5Xml.dll" />
				</Component>
				<Component Id="RemoveAllFilesComponent" DiskId="1" Guid="{5587F628-F9A8-4D0C-B300-86A10812613E}"> 
					<RegistryValue Root="HKLM" Key="SOFTWARE\KeyChain\KeyChain" Name="Path" Action="write" Type="string" Value="[INSTALLLOCATION]" KeyPath="yes" />
					<Condition><![CDATA[REMOVEKEYS = "0"]]></Condition> 
					<RemoveFolder Id="RemoveRootFolder" Directory="INSTALLLOCATION" On="uninstall"/> 
					<RemoveFile	Id="RemoveRootFiles" Directory="INSTALLLOCATION" On="uninstall" Name="*"/>
				</Component> 
			</Directory>
		</Directory>
		<!-- Registry entries -->
        <Component Id="RegValInstallLocation" Guid="{49C9C91A-DC36-4F76-B81E-33E77243CB09}">
           <RegistryKey Root="HKLM" Key="SOFTWARE\KeyChain\KeyChain" ForceDeleteOnUninstall="yes">
              <RegistryValue Name="InstallLocation" Value="[INSTALLLOCATION]" Type="string" KeyPath="yes" />
           </RegistryKey>
        </Component>
    </Directory>

	<!-- Install directory source text override -->
	<Property Id="WIXUI_INSTALLDIR" Value="INSTALLLOCATION" />

	<!-- Set custom icons and images in dialogs -->
	<WixVariable Id="WixUIBannerBmp" Value="keychain_banner.jpg" />
	<WixVariable Id="WixUIDialogBmp" Value="keychain_dialog_banner.jpg" /> 
	<WixVariable Id="WixUIExclamationIco" Value="keychain_logo_maximal.ico" />
	<WixVariable Id="WixUIInfoIco" Value="keychain_logo_maximal.ico" />
	<WixVariable Id="WixUINewIco" Value="keychain_logo_minimal.ico" />
	<WixVariable Id="WixUIUpIco" Value="keychain_logo_minimal.ico" />
	
	<!-- License source text override -->
	<WixVariable Id="WixUILicenseRtf" Value="license.rtf" />

	<!-- Group components as components referencies -->
    <Feature Id="InstallFeature" Title="Install Feature" Level="1" ConfigurableDirectory="INSTALLLOCATION">
        <ComponentRef Id="Component1" />
		<ComponentRef Id="Component2" />
		<ComponentRef Id="Component3" />
		<ComponentRef Id="Component4" />
		<ComponentRef Id="Component5" />
		<ComponentRef Id="Component6" />
		<ComponentRef Id="Component7" />
		<ComponentRef Id="Component8" />
		<ComponentRef Id="Component10" />
		<ComponentRef Id="Component11" />
		<ComponentRef Id="Component12" />
		<ComponentRef Id="Component13" />
		<ComponentRef Id="Component14" />
		<ComponentRef Id="Component15" />
		<ComponentRef Id="Component16" />
		<ComponentRef Id="Component17" />
		<ComponentRef Id="Component18" />
		<ComponentRef Id="Component19" />
		<ComponentRef Id="Component20" />
		<ComponentRef Id="Component21" />
		<ComponentRef Id="Component22" />
		<ComponentRef Id="Component23" />
		<ComponentRef Id="Component24" />
		<ComponentRef Id="Component25" />
		<ComponentRef Id="Component26" />
		<ComponentRef Id="Component27" />
		<ComponentRef Id="Component28" />
		<ComponentRef Id="Component29" />
		<ComponentRef Id="Component30" />
		<ComponentRef Id="Component31" />
		<ComponentRef Id="Component32" />
		<ComponentRef Id="Component33" />
		<ComponentRef Id="Component34" />
		<ComponentRef Id="Component35" />
		<ComponentRef Id="Component36" />
		<ComponentRef Id="Component37" />
		<ComponentRef Id="Component38" />
		<ComponentRef Id="Component39" />
		<ComponentRef Id="Component40" />
		<ComponentRef Id="Component41" />
		<ComponentRef Id="Component42" />
		<ComponentRef Id="Component43" />
		<ComponentRef Id="Component44" />
		<ComponentRef Id="Component45" />
		<ComponentRef Id="Component46" />
		<ComponentRef Id="Component47" />
		<ComponentRef Id="Component48" />
		<ComponentRef Id="Component49" />
		<ComponentRef Id="RemoveAllFilesComponent"/> 
		<ComponentRef Id="RegValInstallLocation"/> 
    </Feature>
	
    <!-- Global Run Action -->
    <CustomAction Id="RunWrapExe" Return="ignore" Execute="deferred" 
                  FileKey="File0" ExeCommand="setup.exe param here"  
                  HideTarget="no" Impersonate="no" />
				  			  
	<!-- Additional action after installation -->			  
	<CustomAction Id="RunWsserviceInstallation" Directory="INSTALLLOCATION"
	ExeCommand='"[INSTALLLOCATION]wsservice_manager.BAT"'
    Execute="deferred" Impersonate="no" Return="check"/>
	
	<!-- Additional action after uninstall -->	
	<CustomAction Id="BeforeUninstallService" Directory="INSTALLLOCATION"
    ExeCommand='"[INSTALLLOCATION]delete_wsservice.BAT"'
    Execute="deferred" Impersonate="no" Return="check"/>
	
	<!-- Additional action after every installation/update -->	
	<CustomAction Id="RunCheckService" Directory="INSTALLLOCATION"
    ExeCommand='"[INSTALLLOCATION]check_service.BAT"'
    Execute="deferred" Impersonate="no" Return="check"/>

	<!-- Overall install & uninstall actions execution block -->	
    <InstallExecuteSequence>
        <Custom Action="RunWrapExe" After="InstallFiles">NOT REMOVE~="ALL"</Custom>
		<Custom Action="RunCheckService" Before="InstallFinalize">NOT (REMOVE~="ALL")</Custom>
		<Custom Action="RunWsserviceInstallation" Before="InstallFinalize">NOT (REMOVE~="ALL")</Custom>
		<Custom Action="BeforeUninstallService" After="InstallInitialize">REMOVE="ALL"</Custom>
    </InstallExecuteSequence>
	
	<!-- Embed vcredist (VC1.41) for x86-x32 & x86-x64 target platforms -->
	<DirectoryRef Id="TARGETDIR">
		<!-- Handle x64 vcredist files -->
		<!-- Or use $(env.CommonProgramFiles) alias if it's not x86 in folder name -->
		<?if $(var.ProcessorArchitecture)="AMD64" or $(var.ProcessorArchitecture)="x64" or $(var.ProcessorArchitecture)="Intel64" ?> 
			<Merge Id="CrtFiles_x64" SourceFile="$(var.vcrpath)\Microsoft_VC141_CRT_x64.msm" DiskId="1" Language="0"/>
			<Merge Id="CrtPolicy_x64" SourceFile="$(var.vcrpath)\Microsoft_VC141_DebugCRT_x64.msm" DiskId="1" Language="0"/>
		<?endif?>
		<!-- Handle x64 vcredist files -->
		<?if $(var.ProcessorArchitecture)="x86" or $(var.ProcessorArchitecture)="Intel" ?> 
			<!-- (VC141) -->
			<Merge Id="CrtFiles_x86" SourceFile="$(var.vcrpath)\Microsoft_VC141_CRT_x86.msm" DiskId="1" Language="0"/>
			<Merge Id="CrtPolicy_x86" SourceFile="$(var.vcrpath)\Microsoft_VC141_DebugCRT_x86.msm" DiskId="1" Language="0"/>
		<?endif?> 
		<?warning Architecture type: $(var.ProcessorArchitecture) ?>
	</DirectoryRef>
	
	<!-- Merge specific version of vcredist -->
	<Feature Id="VCRedist" Title="Visual C++ 14.0 Runtime" AllowAdvertise="no" Display="hidden" Level="1">
		<?if $(var.ProcessorArchitecture)="AMD64" or $(var.ProcessorArchitecture)="x64" ?>
			<MergeRef Id="CrtFiles_x64"/>
			<MergeRef Id="CrtPolicy_x64"/>
		<?endif?>
		<?if $(var.ProcessorArchitecture)="x86" or $(var.ProcessorArchitecture)="Intel" ?> 
			<MergeRef Id="CrtFiles_x86"/>
			<MergeRef Id="CrtPolicy_x86"/>
		<?endif?> 
	</Feature>
	
	<!-- Define the installer UI -->
	<UI>
		<UIRef Id="CustomWixUI_Mondo" />
    </UI>
	
	<Property Id="REMOVEKEYS" Value="1" Secure="yes"/>

   </Product>
</Wix>